Transform: AWS::Serverless-2016-10-31
Description: SAM Textract Lambda stack
Parameters:
  DemoUser:
    Description: The demo user name to connect to Postgres.
    Type: String
  ConfigKeyName:
    Description: The name of the Config File for Writer Lamdba Function
    Type: String
  ConfigBucketName:
    Description: The name of the s3 bucket housing the writer lamdba config File
    Type: String
  TableName:
    Description: The name of target table used in DBWriter Lamdba function
    Type: String
Globals:
  Function:
    Timeout: 60
Resources:
  UploadBucket:
    Type: AWS::S3::Bucket
  SNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: LambdaSNSTopic
      TopicName: LambdaSNSTopic
  ARCHERClaimantSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: ARCHERClaimantSNSTopic
      TopicName: ARCHERClaimantSNSTopic
  ReadFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: index.lambda_handler
      CodeUri: ReadFunction
      Role:
        Fn::GetAtt:
        - ReadLambdaExecutionRole
        - Arn
      Events:
        InvoiceUploadEvent:
          Type: S3
          Properties:
            Bucket:
              Ref: UploadBucket
            Events: s3:ObjectCreated:*
      Environment:
        Variables:
          SNSROLEARN:
            Fn::GetAtt:
            - SNSRole
            - Arn
          SNSTOPIC:
            Ref: SNSTopic
  WriteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: index.lambda_handler
      Layers:
      - Ref: WriteFunctionDepLayer
      CodeUri: WriteFunction
      Role:
        Fn::GetAtt:
        - WriteLambdaExecutionRole
        - Arn
      Environment:
        Variables:
          DBEndPoint:
            Fn::ImportValue: DBEndpointAddress
          DatabaseName:
            Fn::ImportValue: DBName
          DBUserName:
            Ref: DemoUser
          ConfigBucket:
            Ref: ConfigBucketName
          ConfigKey:
            Ref: ConfigKeyName
  WriteFunctionDepLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: write-function-app-dependencies
      Description: Dependencies for sam app
      ContentUri: ..\..\functions\writer\dependencies
      CompatibleRuntimes:
      - python3.7
      LicenseInfo: MIT
      RetentionPolicy: Retain
  DbWriterFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: index.lambda_handler
      Layers:
      - Ref: WriteFunctionDepLayer
      CodeUri: DbWriterFunction
      Role:
        Fn::GetAtt:
        - WriteLambdaExecutionRole
        - Arn
      Environment:
        Variables:
          DBEndPoint:
            Fn::ImportValue: DBEndpointAddress
          DatabaseName:
            Fn::ImportValue: DBName
          DBUserName:
            Ref: DemoUser
          TableName:
            Ref: TableName
  Subscription1:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint:
        Fn::GetAtt:
        - DbWriterFunction
        - Arn
      Protocol: lambda
      TopicArn:
        Ref: ARCHERClaimantSNSTopic
  InvokePermission1:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: DbWriterFunction
      Principal: sns.amazonaws.com
  Subscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint:
        Fn::GetAtt:
        - WriteFunction
        - Arn
      Protocol: lambda
      TopicArn:
        Ref: SNSTopic
  InvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: WriteFunction
      Principal: sns.amazonaws.com
  SNSRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - textract.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: sns-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - sns:publish
            Resource:
              Ref: SNSTopic
  ReadLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: sns-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - sns:*
            Resource: '*'
      - PolicyName: cloudwatch-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource: arn:aws:logs:*:*:*
      - PolicyName: textract-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - textract:*
            Resource: '*'
      - PolicyName: s3-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:GetObject
            Resource: '*'
  WriteLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: cloudwatch-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource: arn:aws:logs:*:*:*
      - PolicyName: textract-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - textract:*
            Resource: '*'
      - PolicyName: s3access-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:*
            Resource: '*'
      - PolicyName: sns-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - sns:*
            Resource: '*'
      - PolicyName: rds-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - rds-db:connect
            Resource:
              Fn::Sub: arn:aws:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:*/${DemoUser}
